doctype html
html(lang='en')
  head
    meta(charset='UTF-8')
    meta(name='viewport' content='width=device-width, initial-scale=1.0')
    title PSLvis
    // Include Bootstrap CSS from CDN
    link(href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' rel='stylesheet')
    link(href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet") 
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous")
    script(src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.11/dist/htmx.min.js")
    script(src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js")
    script(src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js")
  body
    header.navbar.navbar-expand-lg.sticky-top.bg-success-subtle
      nav.container-xxl.flex-wrap.flex-lg-nowrap 
        ul.nav 
          li.nav-item 
            h1 PSLvis
        ul.nav
          li.nav-item
            a.link-secondary.link-underline.link-underline-opacity-0(href="https://github.com/TRR318/scikit-psl")
              span.mdi.mdi-github.fs-4.btn.btn-sm
              span Algorithm
          li.nav-item
            a.link-secondary.link-underline.link-underline-opacity-0(href="https://github.com/TRR318/pslvis")
              span.mdi.mdi-github.fs-4.btn.btn-sm
              span Visualization

    include pslresult.pug
    
    script.
      function loadStart(){
        document.querySelectorAll("#feature-container .loading").forEach(e => {
          e.classList.add("opacity-25");
          e.style.pointerEvents = "none";
          e.style.userSelect = "none";
        });
        document.querySelectorAll("#feature-container .spinner-border")
          .forEach(e => e.classList.remove("d-none"));
      }

      function reset(){
        loadStart();
        htmx.ajax("GET", "/update-table", {
                    target: "#feature-container",
                    swap: "outerHTML",
                    values: {
                      type: "reset",
                    }
                  });
      }
      function add(){
        loadStart();
        htmx.ajax("GET", "/update-table", {
                    target: "#feature-container",
                    swap: "outerHTML",
                    values: {
                      type: "add",
                    }
                  });
      }
      function fill(){
        loadStart();
        htmx.ajax("GET", "/update-table", {
                    target: "#feature-container",
                    swap: "outerHTML",
                    values: {
                      type: "fill",
                    }
                  });
      }

      function initialize() {
        document.querySelectorAll("#feature-container ul")
          .forEach(ul => {
            new Sortable(ul, {
              animation:150,
              group: "features",
              ghostClass: "ghost",	
              handle: ".draghandle",
              onEnd: function(evt) {
                if (evt.oldIndex !== evt.newIndex || evt.from.id !== evt.to.id) {
                  // Trigger htmx to send information to the server
                  evt.item.classList.add("ghost")
                  loadStart();
                  htmx.ajax("GET", "/update-table", {
                    target: "#feature-container",
                    swap: "outerHTML",
                    values: {
                      type: "feature",
                      from: evt.oldIndex,
                      to: evt.newIndex,
                      feature: evt.item.dataset.feature,
                      fromList: evt.from.id,
                      toList: evt.to.id,
                    }
                  });
                }
              }
            });
          })
      }

      document.addEventListener('DOMContentLoaded', initialize);
      document.body.addEventListener('htmx:afterSwap', initialize);